从零开始说起……


## CMOS

记录主板上参数的芯片，例如：CPU 与内存的频率。这颗芯片需要借着额外的电源来发挥记录功能，所以主板上有一颗电池。


## BIOS

那 CMOS 内的数据如何读取与更新呢？还记得你的计算机在开机的时候可以按下 F2 按键来进入一个名为 BIOS 的画面吧？

BIOS(Basic Input Output System)是一套程序，这套程序是写死到主板上面的一个内存芯片中， 这个内存芯片在没有通电时也能够将数据记录下来。BIOS 对于个人计算机来说是非常重要的， 因为他是系统在开机的时候首先会去读取的一个小程序喔！

> BIOS 对计算机系统来讲是非常重要的，因为他掌握了系统硬件的详细信息与开机设备的选择等等。但是计算机发展的速度太快了， 因此 BIOS 程序代码也可能需要作适度的修改才行，所以你才会在很多主板官网找到 BIOS 的更新程序！ 
>
> 但是 BIOS 原本使用的是无法改写的 ROM ，因此根本无法修正 BIOS 程序代码！为此，现在的 BIOS 通常是写入类似闪存(flash) 或EEPROM 中。


## CMOS 与 BIOS

CMOS 是一颗芯片，主要功能是记录主板上面的重要参数，包括系统时间、CPU 电压与频率、各项设备的 I/O 地址与 IRQ 等，由于这些数据的记录要花费电力，因此主板上面才有电池。

BIOS 是写入到主板上某一块 flash 或 EEPROM 的程序，它可以在开机的时候执行，以加载 CMOS 当中的参数， 并尝试呼叫储存装置中的开机程序，进一步进入操作系统当中。



## 开机流程

开机时计算机还没有任何软件系统，那它要如何读取硬盘内的操作系统文件呢？嘿嘿！这就得要牵涉到计算机的开机程序了！ 

基本上，目前的主机系统在加载硬件驱动方面的程序，主要有早期的 BIOS 与新的 UEFI 两种机制，我们分别来谈谈！


#### 一、BIOS 搭配 MBR/GPT 的开机流程

简单的说，整个开机流程到操作系统之前的动作应该是这样的：

1. BIOS：开机主动执行的韧体(Firmware)，会识别第一个可开机的装置(MBR)；

2. MBR：第一个可开机装置的**第一个扇区**内的主要启动记录区块，内含开机管理程序(boot loader)；

    > 如果你的分区表为 GPT 格式的话，那么BIOS 也能够从 LBA0 的 MBR 兼容区块读取第一阶段的开机管理程序代码， 如果你的开机管理程序能够认识 GPT 的话，那么使用BIOS同样可以读取到正确的操作系统核心！
    >
    > 由于 LBA0 仅提供第一阶段的开机管理程序代码，因此如果你使用类似 grub 的开机管理程序的话，那么就得要额外分区出一个『BIOS boot』的分区槽， 这个分区槽才能够放置其他开机过程所需的程序代码！

3. 开机管理程序(boot loader)：一支可读取核心文件来执行的软件；

    > Boot loader 则是操作系统安装在 MBR 上面的一套软件了。由于 MBR 仅有 446 bytes 而已，因此这个开机管理程序是非常小而美的。这个 boot loader 的主要任务有底下这些项目：
    >
    > * 提供选单：用户可以选择不同的开机项目，这也是多重引导的重要功能！
    >
    > * 载入核心文件：直接指向可开机的程序区段来开始操作系统；
    >
    > * 转交其他 loader：将开机管理功能转交给其他 loader 负责。
    >
    >   > 开机管理程序除了可以安装在 MBR 之外， 还可以安装在每个分区槽的启动扇区(boot sector)

4. 核心文件：开始操作系统的功能...


#### 二、UEFI BIOS 搭配 MBR 开机的流程

不支持


#### 三、UEFI BIOS 搭配 GPT 开机的流程

BIOS 并不能直接识别 GPT，它需要通过 GPT 提供兼容模式（LBA0 的MBR 兼容区块）才能够读写这个磁盘装置！

因此有了 UEFI 的诞生，UEFI 主要是想要取代 BIOS 这个韧体界面，因此我们也称 UEFI 为 UEFI BIOS。开机流程同基本 BIOS 相同！

传统 BIOS 与 UEFI 的差异如下：

| 比较项目                 | 传统 BIOS                                                    | UEFI BIOS          |
| ------------------------ | ------------------------------------------------------------ | ------------------ |
| 使用程序语言             | 汇编语言                                                     | C 语言             |
| 硬件资源控制             | 使用中断 (IRQ) 管理<br/>不可变的内存存取<br/>不可变得输入/输出存取 | 使用驱动程序与协议 |
| 处理器运作环境           | 16 位                                                        | CPU 保护模式       |
| 第三方厂商支持           | 较差                                                         | 较佳且可支持多平台 |
| 图形化能力               | 较差                                                         | 较佳               |
| 内建简化版操作系统前环境 | 不支持                                                       | 支持               |

此外，由于过去 cracker 经常藉由 BIOS 开机阶段来破坏系统，并取得系统的控制权，因此 UEFI 加入了一个所谓的安全启动(secure boot) 机制， 这个机制代表着即将开机的操作系统必须要被 UEFI 所验证，否则就无法顺利开机！微软用了很多这样的机制来管理硬件。不过加入这个机制后，许多的操作系统，包括 Linux ，就很有可能无法顺利开机喔！<span style="color:#ea4355">所以，某些时刻，你可能得要将 UEFI 的 secure boot 功能关闭， 才能够顺利的进入 Linux 哩！</span>

另外，与 BIOS 模式相比，虽然 UEFI 可以直接取得 GPT 的分区表，不过<span style="color:#ea4355">最好依旧拥有 BIOS boot 的分区槽支持</span>。同时，为了与 windows 兼容，并且提供其他第三方厂商所使用的 UEFI 应用程序储存的空间，<span style="color:#ea4355">你必须要格式化一个 vfat 的文件系统， 大约提供 512MB 到1G 左右的容量</span>，以让其他 UEFI 执行较为方便。


## 总结—分区方案


#### 一、BIOS + MBR

| 所需目录 | 磁盘容量 | 文件系统 | 分区格式  |
| -------- | -------- | -------- | --------- |
| /boot    | 1G       | xfs      | 主分区(p) |
| /        | 40G      | xfs      | 主分区(p) |
| /home    | 10G      | xfs      | 主分区(p) |
| swap     | 1G       | swap     | 主分区(p) |


#### 二、BIOS + GPT

| 所需目录  | 磁盘容量 | 文件系统             | 分区格式                  |
| --------- | -------- | -------------------- | ------------------------- |
| BIOS boot | 2M       | 系统自定义(unformat) | biosboot(ef02)            |
| /boot     | 1G       | xfs                  | 主分区(8300)              |
| /         | 40G      | xfs                  | 主分区/LVM方式(8300/8e00) |
| /home     | 10G      | xfs                  | 主分区/LVM方式(8300/8e00) |
| swap      | 1G       | swap                 | 主分区/LVM方式(8300/8e00) |


#### 三、UEFI + GPT

| 所需目录  | 磁盘容量 | 文件系统             | 分区格式                  |
| --------- | -------- | -------------------- | ------------------------- |
| BIOS boot | 2M       | 系统自定义(unformat) | biosboot(ef02)            |
| /boot/efi | 1G       | vfat(fat32)          | EFI(ef00)                 |
| /boot     | 1G       | xfs                  | 主分区(8300)              |
| /         | 40G      | xfs                  | 主分区/LVM方式(8300/8e00) |
| /home     | 10G      | xfs                  | 主分区/LVM方式(8300/8e00) |
| swap      | 1G       | swap                 | 主分区/LVM方式(8300/8e00) |